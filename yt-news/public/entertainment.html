<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⛵ Entertainment Feed</title>
  <style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f0f0f;
    color: #fff;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }
  h1 { 
    font-size: 28px; 
    margin-bottom: 8px;
    color: #fff;
  }
  .subtitle {
    color: #aaa;
    font-size: 14px;
    margin-bottom: 30px;
  }
  .sync-status {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
  }
  .sync-status.synced { color: #4a4; }
  .sync-status.syncing { color: #aa4; }
  .sync-status.error { color: #a44; }
  .category { margin-bottom: 40px; }
  .category h2 { 
    font-size: 20px; 
    margin-bottom: 16px;
    color: #fff;
    border-bottom: 1px solid #333;
    padding-bottom: 8px;
  }
  .video-card {
    background: #1a1a1a;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    transition: opacity 0.3s, border 0.2s;
    position: relative;
  }
  .video-card.watched {
    opacity: 0.5;
  }
  .video-card.selected {
    border: 2px solid #4a9eff;
  }
  .video-card.watched .video-title::before {
    content: "✓ ";
    color: #4a4;
  }
  .video-header {
    display: flex;
    gap: 16px;
    padding: 16px;
    cursor: pointer;
  }
  .video-header:hover {
    background: #252525;
  }
  .video-card.watched .video-header:hover {
    opacity: 1;
  }
  .select-checkbox {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 20px;
    height: 20px;
    cursor: pointer;
    z-index: 10;
    accent-color: #4a9eff;
  }
  .thumb-container {
    position: relative;
    flex-shrink: 0;
  }
  .thumb {
    width: 200px;
    height: 112px;
    border-radius: 8px;
    object-fit: cover;
    background: #333;
  }
  .new-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    background: #ff0000;
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .duration {
    background: rgba(0,0,0,0.8);
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 12px;
    position: absolute;
    bottom: 6px;
    right: 6px;
  }
  .video-info {
    flex: 1;
    min-width: 0;
  }
  .creator-name {
    font-size: 12px;
    color: #888;
    margin-bottom: 4px;
  }
  .creator-name a {
    color: #aaa;
    text-decoration: none;
  }
  .creator-name a:hover {
    color: #fff;
    text-decoration: underline;
  }
  .video-title {
    font-size: 16px;
    font-weight: 500;
    color: #fff;
    line-height: 1.4;
    margin-bottom: 8px;
  }
  .video-meta {
    display: flex;
    gap: 12px;
    font-size: 13px;
    color: #888;
  }
  .video-date {
    color: #aaa;
  }
  .player-container {
    display: none;
    background: #000;
  }
  .player-container.active {
    display: block;
  }
  .player-container iframe {
    width: 100%;
    aspect-ratio: 16/9;
    border: none;
  }
  .controls {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }
  .controls button {
    background: #333;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .controls button:hover {
    background: #444;
  }
  .controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #play-selected-btn:not(:disabled) {
    background: #4a4;
    color: #fff;
  }
  #play-selected-btn:not(:disabled):hover {
    background: #5b5;
  }
  #playlist-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 12px 20px;
    display: none;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
    border-top: 2px solid #4a9eff;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
  }
  .playlist-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .playlist-progress {
    background: #4a9eff;
    color: #fff;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 14px;
  }
  .playlist-title {
    color: #ccc;
    font-size: 14px;
  }
  .playlist-controls {
    display: flex;
    gap: 10px;
  }
  .playlist-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }
  .playlist-controls button:first-child {
    background: #4a4;
    color: #fff;
  }
  .playlist-controls button:last-child {
    background: #666;
    color: #fff;
  }
  .playlist-controls button:hover {
    opacity: 0.9;
  }
  .selection-count {
    font-size: 14px;
    color: #4a9eff;
    font-weight: 500;
  }
  .channel-pending {
    display: none;
    margin-bottom: 16px;
  }
  .pending-text {
    background: #1a2a1a;
    border-left: 3px solid #4a4;
    padding: 10px 14px;
    margin-bottom: 8px;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    font-size: 14px;
  }
  .pending-text:hover {
    background: #253525;
  }
  .pending-text .new-tag {
    color: #6c6;
    font-weight: 600;
    margin-right: 8px;
  }
  .stats-footer {
    display: flex;
    justify-content: flex-end;
    gap: 30px;
    margin-bottom: 20px;
    padding: 12px 20px;
    background: #1a1a1a;
    border-radius: 12px;
  }
  .stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .stat-label {
    color: #888;
    font-size: 13px;
  }
  .stat-value {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
  }
  #watched-duration { color: #f44; }
  #remaining-duration { color: #4a4; }
  .updated {
    text-align: center;
    color: #555;
    font-size: 12px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #222;
  }
  .top-nav {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .top-nav a {
    color: #888;
    text-decoration: none;
    font-size: 14px;
  }
  .top-nav a:hover { color: #fff; }
  .settings-link { color: #4a9eff; }
  @media (max-width: 600px) {
    .video-header { flex-direction: column; }
    .thumb { width: 100%; height: auto; aspect-ratio: 16/9; }
  }
</style>
</head>
<body>
  <nav class="top-nav">
    <a href="https://youtube-playlists-alpha.vercel.app" class="back-link">← Home</a>
    <a href="https://youtube-playlists-alpha.vercel.app/settings" class="settings-link">⚙️ Manage Channels</a>
  </nav>
  <h1>⛵ Entertainment Feed</h1>
  <p class="subtitle">Sailing content for leisure time • Click to play</p>
  <div id="sync-status" class="sync-status">Loading...</div>
  
  <div class="stats-footer">
    <div class="stat-item">
      <span class="stat-label">Total on page:</span>
      <span class="stat-value" id="total-duration">--</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Watched:</span>
      <span class="stat-value" id="watched-duration">--</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Remaining:</span>
      <span class="stat-value" id="remaining-duration">--</span>
    </div>
  </div>
  
  <div class="controls">
    <button onclick="hideWatched()">Hide Watched</button>
    <button onclick="clearWatched()">Clear History</button>
    <button id="play-selected-btn" onclick="playSelected()" disabled>▶ Play Selected</button>
    <button id="refresh-selected-btn" onclick="refreshSelected()" disabled>Refresh Selected</button>
    <span id="selection-count" class="selection-count"></span>
  </div>
  <div class="category">
    <h2>Sailing</h2>
    <div class="video-card" data-video-id="HFsjRc4Y2t0" data-creator="Practical Sailor" data-duration="9:03">
      <input type="checkbox" class="select-checkbox" onclick="toggleSelect('HFsjRc4Y2t0', this, event)">
      <div class="video-header" onclick="togglePlayer(this.parentElement, 'HFsjRc4Y2t0')">
        <div class="thumb-container">
          <img class="thumb" src="https://i.ytimg.com/vi/HFsjRc4Y2t0/hqdefault.jpg" alt="" loading="lazy">
          <span class="new-badge">NEW</span>
          <span class="duration">9:03</span>
        </div>
        <div class="video-info">
          <div class="creator-name"><a href="https://www.youtube.com/@practical-sailor" target="_blank" onclick="event.stopPropagation()">Practical Sailor</a></div>
          <div class="video-title">This “Bulletproof” Cruiser Has a Serious Weak Spot Caliber 40 LRC SE</div>
          <div class="video-meta">
            <span class="video-date">4 days ago</span>
            <span>14K views</span>
          </div>
        </div>
      </div>
      <div class="player-container"></div>
    </div>
    <div class="channel-pending" data-creator="Practical Sailor"></div>
    <div class="video-card" data-video-id="2nqPuQtLQE4" data-creator="New Kids On The Dock" data-duration="34:16">
      <input type="checkbox" class="select-checkbox" onclick="toggleSelect('2nqPuQtLQE4', this, event)">
      <div class="video-header" onclick="togglePlayer(this.parentElement, '2nqPuQtLQE4')">
        <div class="thumb-container">
          <img class="thumb" src="https://i.ytimg.com/vi/2nqPuQtLQE4/hqdefault.jpg" alt="" loading="lazy">
          <span class="new-badge">NEW</span>
          <span class="duration">34:16</span>
        </div>
        <div class="video-info">
          <div class="creator-name"><a href="https://www.youtube.com/@Thenewkidsonthedock" target="_blank" onclick="event.stopPropagation()">New Kids On The Dock</a></div>
          <div class="video-title">Catamaran of our Dreams - But First? Finish These RUDDERS!</div>
          <div class="video-meta">
            <span class="video-date">1 day ago</span>
            <span>97K views</span>
          </div>
        </div>
      </div>
      <div class="player-container"></div>
    </div>
    <div class="channel-pending" data-creator="New Kids On The Dock"></div>
    <div class="video-card" data-video-id="XhZZCNfBmLI" data-creator="Sailing Parlay Revival" data-duration="23:23">
      <input type="checkbox" class="select-checkbox" onclick="toggleSelect('XhZZCNfBmLI', this, event)">
      <div class="video-header" onclick="togglePlayer(this.parentElement, 'XhZZCNfBmLI')">
        <div class="thumb-container">
          <img class="thumb" src="https://i.ytimg.com/vi/XhZZCNfBmLI/hqdefault.jpg" alt="" loading="lazy">
          <span class="new-badge">NEW</span>
          <span class="duration">23:23</span>
        </div>
        <div class="video-info">
          <div class="creator-name"><a href="https://www.youtube.com/@ParlayRevival" target="_blank" onclick="event.stopPropagation()">Sailing Parlay Revival</a></div>
          <div class="video-title">REBUILDING OUR HULLS: Blister repair series - part 4  (Episode 350)</div>
          <div class="video-meta">
            <span class="video-date">5 days ago</span>
            <span>161K views</span>
          </div>
        </div>
      </div>
      <div class="player-container"></div>
    </div>
    <div class="channel-pending" data-creator="Sailing Parlay Revival"></div>
  </div>
<div class="updated">Last updated: Feb 13, 2026, 4:02 PM PST</div>
  <script>
  const BLOB_URL = '/api/sync?feed=news';
  let userData = { watched: {}, myVideos: {}, pendingNew: [] };
  let syncTimeout = null;
  let selectedVideos = new Set();
  let playlistQueue = [];
  let currentPlayingIndex = -1;
  
  // Get page type from URL
  const pageType = location.pathname.includes('entertainment') ? 'entertainment' : 'research';
  
  async function loadUserData() {
    setStatus('syncing', 'Loading...');
    try {
      const res = await fetch(BLOB_URL);
      const data = await res.json();
      userData = {
        watched: data.watched || {},
        myVideos: data.myVideos || {},
        pendingNew: data.pendingNew || []
      };
      
      // First visit: if no myVideos for this page, add all current videos
      if (!userData.myVideos[pageType] || Object.keys(userData.myVideos[pageType]).length === 0) {
        userData.myVideos[pageType] = {};
        document.querySelectorAll('.video-card:not(.pending-new)').forEach(card => {
          const videoId = card.dataset.videoId;
          const creator = card.dataset.creator;
          userData.myVideos[pageType][videoId] = { 
            added: Date.now(),
            creator: creator
          };
        });
        await saveUserData();
      }
      
      updateUI();
      showPendingNewVideos();
      setStatus('synced', 'Synced ✓');
    } catch (e) {
      console.error('Load failed:', e);
      setStatus('error', 'Sync failed');
    }
  }
  
  async function saveUserData() {
    setStatus('syncing', 'Saving...');
    try {
      await fetch(BLOB_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });
      setStatus('synced', 'Synced ✓');
    } catch (e) {
      console.error('Save failed:', e);
      setStatus('error', 'Sync failed');
    }
  }
  
  function debouncedSave() {
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(saveUserData, 500);
  }
  
  function setStatus(cls, text) {
    const el = document.getElementById('sync-status');
    if (el) {
      el.className = 'sync-status ' + cls;
      el.textContent = text;
    }
  }
  
  function setWatched(videoId) {
    userData.watched[videoId] = Date.now();
    debouncedSave();
  }
  
  function isWatched(videoId) {
    return !!userData.watched[videoId];
  }
  
  function updateUI() {
    document.querySelectorAll('.video-card:not(.pending-new)').forEach(card => {
      const videoId = card.dataset.videoId;
      
      if (isWatched(videoId)) {
        card.classList.add('watched');
      } else {
        card.classList.remove('watched');
      }
      
      if (selectedVideos.has(videoId)) {
        card.classList.add('selected');
        card.querySelector('.select-checkbox').checked = true;
      } else {
        card.classList.remove('selected');
        card.querySelector('.select-checkbox').checked = false;
      }
    });
    
    updateSelectionCount();
  }
  
  function toggleSelect(videoId, checkbox, event) {
    event.stopPropagation();
    if (checkbox.checked) {
      selectedVideos.add(videoId);
    } else {
      selectedVideos.delete(videoId);
    }
    updateUI();
  }
  
  function updateSelectionCount() {
    const countEl = document.getElementById('selection-count');
    const count = selectedVideos.size;
    
    if (countEl) {
      if (count > 0) {
        // Calculate total duration of selected videos
        let totalSeconds = 0;
        document.querySelectorAll('.video-card').forEach(card => {
          if (selectedVideos.has(card.dataset.videoId)) {
            totalSeconds += parseDuration(card.dataset.duration);
          }
        });
        const durationStr = formatDuration(totalSeconds);
        countEl.textContent = count + ' selected (' + durationStr + ')';
      } else {
        countEl.textContent = '';
      }
    }
    
    const refreshBtn = document.getElementById('refresh-selected-btn');
    if (refreshBtn) {
      refreshBtn.disabled = count === 0;
    }
    
    const playBtn = document.getElementById('play-selected-btn');
    if (playBtn) {
      playBtn.disabled = count === 0;
    }
  }
  
  function refreshSelected() {
    if (selectedVideos.size === 0) {
      alert('Select videos to refresh by clicking their checkboxes');
      return;
    }
    selectedVideos.forEach(videoId => {
      if (userData.myVideos[pageType]) {
        delete userData.myVideos[pageType][videoId];
      }
    });
    selectedVideos.clear();
    saveUserData().then(() => {
      alert('Selected videos will be refreshed on next update. Reload to see changes.');
    });
  }
  
  function showPendingNewVideos() {
    // Get video IDs already on the page
    const onPageIds = new Set();
    document.querySelectorAll('.video-card[data-video-id]').forEach(card => {
      onPageIds.add(card.dataset.videoId);
    });
    
    // Filter pending videos to only this feed's pageType AND not already on page
    const pending = userData.pendingNew.filter(v => 
      v.pageType === pageType && !onPageIds.has(v.videoId)
    );
    
    // Group by creator
    const byCreator = {};
    pending.forEach(v => {
      if (!byCreator[v.creator]) byCreator[v.creator] = [];
      byCreator[v.creator].push(v);
    });
    
    // Show pending videos as simple text under each channel
    document.querySelectorAll('.channel-pending').forEach(container => {
      const creator = container.dataset.creator;
      const videos = byCreator[creator] || [];
      
      if (videos.length === 0) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
      }
      
      container.style.display = 'block';
      container.innerHTML = videos.map(v => `
        <div class="pending-text" onclick="addPendingVideo('${v.videoId}')">
          <span class="new-tag">+ NEW:</span> ${v.title}
        </div>
      `).join('');
    });
  }
  
  function addPendingVideo(videoId) {
    const pending = userData.pendingNew.find(v => v.videoId === videoId);
    if (!pending) return;
    
    if (!userData.myVideos[pageType]) userData.myVideos[pageType] = {};
    userData.myVideos[pageType][videoId] = {
      added: Date.now(),
      creator: pending.creator
    };
    
    userData.pendingNew = userData.pendingNew.filter(v => v.videoId !== videoId);
    
    saveUserData().then(() => {
      showPendingNewVideos();
      alert('Video added! Reload page to see it in your list.');
    });
  }
  
  function togglePlayer(card, videoId) {
    const container = card.querySelector('.player-container');
    const isActive = container.classList.contains('active');
    
    document.querySelectorAll('.player-container.active').forEach(p => {
      p.classList.remove('active');
      p.innerHTML = '';
    });
    
    if (!isActive) {
      playVideo(card, videoId);
    }
  }
  
  let ytPlayer = null;
  
  function playVideo(card, videoId) {
    // Close any open players
    document.querySelectorAll('.player-container.active').forEach(p => {
      p.classList.remove('active');
      p.innerHTML = '';
    });
    
    const container = card.querySelector('.player-container');
    container.innerHTML = '<div id="yt-player-container"></div>';
    container.classList.add('active');
    
    // Use YouTube IFrame API for end detection
    if (window.YT && window.YT.Player) {
      createYTPlayer(videoId);
    } else {
      // Load YouTube API if not loaded
      window.onYouTubeIframeAPIReady = () => createYTPlayer(videoId);
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      document.head.appendChild(tag);
    }
    
    setWatched(videoId);
    card.classList.add('watched');
    
    // Scroll card into view
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  function createYTPlayer(videoId) {
    ytPlayer = new YT.Player('yt-player-container', {
      videoId: videoId,
      width: '100%',
      height: '100%',
      playerVars: { autoplay: 1 },
      events: {
        onStateChange: onPlayerStateChange
      }
    });
  }
  
  function onPlayerStateChange(event) {
    // State 0 = ended
    if (event.data === 0 && playlistQueue.length > 0 && currentPlayingIndex >= 0) {
      // Auto-advance to next video
      currentPlayingIndex++;
      playNextInQueue();
    }
  }
  
  function playSelected() {
    if (selectedVideos.size === 0) {
      alert('Select videos to play by clicking their checkboxes');
      return;
    }
    
    // Build queue from selected videos in page order
    playlistQueue = [];
    document.querySelectorAll('.video-card').forEach(card => {
      const videoId = card.dataset.videoId;
      if (selectedVideos.has(videoId)) {
        playlistQueue.push({ videoId, card });
      }
    });
    
    if (playlistQueue.length === 0) return;
    
    // Start playing first video
    currentPlayingIndex = 0;
    playNextInQueue();
  }
  
  function playNextInQueue() {
    hidePlaylistBar();
    
    if (currentPlayingIndex >= playlistQueue.length) {
      // Playlist finished
      playlistQueue = [];
      currentPlayingIndex = -1;
      alert('Playlist finished!');
      return;
    }
    
    const item = playlistQueue[currentPlayingIndex];
    playVideo(item.card, item.videoId);
    showPlaylistBar();
  }
  
  function showPlaylistBar() {
    let bar = document.getElementById('playlist-bar');
    if (!bar) {
      bar = document.createElement('div');
      bar.id = 'playlist-bar';
      document.body.appendChild(bar);
    }
    
    const current = currentPlayingIndex + 1;
    const total = playlistQueue.length;
    const currentTitle = playlistQueue[currentPlayingIndex]?.card.querySelector('.video-title')?.textContent || 'Video';
    
    bar.innerHTML = `
      <div class="playlist-info">
        <span class="playlist-progress">▶ ${current} / ${total}</span>
        <span class="playlist-title">${currentTitle.substring(0, 50)}...</span>
      </div>
      <div class="playlist-controls">
        <button onclick="skipToNext()">Next ⏭</button>
        <button onclick="stopPlaylist()">Stop ✕</button>
      </div>
    `;
    bar.style.display = 'flex';
  }
  
  function hidePlaylistBar() {
    const bar = document.getElementById('playlist-bar');
    if (bar) bar.style.display = 'none';
  }
  
  function skipToNext() {
    currentPlayingIndex++;
    playNextInQueue();
  }
  
  function stopPlaylist() {
    playlistQueue = [];
    currentPlayingIndex = -1;
    hidePlaylistBar();
    document.querySelectorAll('.player-container.active').forEach(p => {
      p.classList.remove('active');
      p.innerHTML = '';
    });
  }
  
  async function clearWatched() {
    if (confirm('Clear all watched markers across all devices?')) {
      userData.watched = {};
      await saveUserData();
      updateUI();
    }
  }
  
  function hideWatched() {
    const hidden = document.body.classList.toggle('hide-watched');
    document.querySelectorAll('.video-card.watched').forEach(card => {
      card.style.display = hidden ? 'none' : 'block';
    });
  }
  
  function parseDuration(str) {
    if (!str) return 0;
    const parts = str.split(':').map(Number);
    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
    if (parts.length === 2) return parts[0] * 60 + parts[1];
    return parts[0] || 0;
  }
  
  function formatDuration(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }
  
  function updateStats() {
    let total = 0, watched = 0;
    document.querySelectorAll('.video-card:not(.pending-new)').forEach(card => {
      const dur = parseDuration(card.dataset.duration);
      total += dur;
      if (card.classList.contains('watched')) {
        watched += dur;
      }
    });
    
    document.getElementById('total-duration').textContent = formatDuration(total);
    document.getElementById('watched-duration').textContent = formatDuration(watched);
    document.getElementById('remaining-duration').textContent = formatDuration(total - watched);
  }
  
  // Call updateStats after UI updates
  const origUpdateUI = updateUI;
  updateUI = function() {
    origUpdateUI();
    updateStats();
  };
  
  document.addEventListener('DOMContentLoaded', () => {
    loadUserData();
    updateStats();
  });
</script>
</body>
</html>